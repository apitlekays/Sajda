name: Download Notifications

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-downloads:
    runs-on: ubuntu-latest
    steps:
      - name: Get current download counts
        id: current
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get download counts for all published releases
          COUNTS=$(gh api repos/${{ github.repository }}/releases --jq '
            [.[] | select(.draft == false) | .assets[] | select(.name | endswith(".dmg")) | {name: .name, count: .download_count}] |
            sort_by(.name) |
            map("\(.name):\(.count)") |
            join(",")
          ')
          echo "counts=$COUNTS" >> $GITHUB_OUTPUT

          # Calculate total DMG downloads
          TOTAL=$(gh api repos/${{ github.repository }}/releases --jq '
            [.[] | select(.draft == false) | .assets[] | select(.name | endswith(".dmg")) | .download_count] | add // 0
          ')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Get previous counts from cache
        id: cache
        uses: actions/cache@v4
        with:
          path: download-counts.txt
          key: download-counts-${{ github.run_id }}
          restore-keys: |
            download-counts-

      - name: Read previous counts
        id: previous
        run: |
          if [ -f download-counts.txt ]; then
            PREV=$(cat download-counts.txt)
            echo "total=$PREV" >> $GITHUB_OUTPUT
          else
            echo "total=0" >> $GITHUB_OUTPUT
          fi

      - name: Check for new downloads and notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          CURRENT=${{ steps.current.outputs.total }}
          PREVIOUS=${{ steps.previous.outputs.total }}

          echo "Previous total: $PREVIOUS"
          echo "Current total: $CURRENT"

          if [ "$CURRENT" -gt "$PREVIOUS" ]; then
            DIFF=$((CURRENT - PREVIOUS))

            # Get latest version info
            LATEST_VERSION=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')

            # Build message
            MESSAGE="ðŸ“¥ *Sajda Download Alert*

+${DIFF} new download(s)!

ðŸ“Š *Total Downloads:* ${CURRENT}
ðŸ·ï¸ *Latest Version:* ${LATEST_VERSION}

[View Releases](https://github.com/${{ github.repository }}/releases)"

            # Send Telegram notification
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"

            echo "Notification sent: +$DIFF downloads"
          else
            echo "No new downloads detected"
          fi

      - name: Save current counts
        run: |
          echo "${{ steps.current.outputs.total }}" > download-counts.txt

      - name: Update cache
        uses: actions/cache/save@v4
        with:
          path: download-counts.txt
          key: download-counts-${{ github.run_id }}
