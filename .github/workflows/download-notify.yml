name: Download Notifications

on:
  schedule:
    # Run every hour
    - cron: '0 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-downloads:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Get current download counts
        id: current
        run: |
          # Calculate total DMG downloads
          TOTAL=$(gh api repos/${{ github.repository }}/releases --jq '
            [.[] | select(.draft == false) | .assets[] | select(.name | endswith(".dmg")) | .download_count] | add // 0
          ')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "Current total: $TOTAL"

      - name: Get previous counts from cache
        id: cache
        uses: actions/cache/restore@v4
        with:
          path: download-counts.txt
          key: sajda-download-counts

      - name: Read previous counts
        id: previous
        run: |
          if [ -f download-counts.txt ]; then
            PREV=$(cat download-counts.txt)
            echo "total=$PREV" >> $GITHUB_OUTPUT
            echo "Previous total from cache: $PREV"
          else
            echo "total=0" >> $GITHUB_OUTPUT
            echo "No previous count found, starting fresh"
          fi

      - name: Check for new downloads and notify
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          CURRENT="${{ steps.current.outputs.total }}"
          PREVIOUS="${{ steps.previous.outputs.total }}"
          echo "Previous total: $PREVIOUS"
          echo "Current total: $CURRENT"
          if [ "$CURRENT" -gt "$PREVIOUS" ]; then
            DIFF=$((CURRENT - PREVIOUS))
            LATEST_VERSION=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
            MESSAGE="ðŸ“¥ Sajda Download Alert%0A%0A+${DIFF} new download(s)!%0A%0AðŸ“Š Total Downloads: ${CURRENT}%0AðŸ·ï¸ Latest Version: ${LATEST_VERSION}%0A%0Ahttps://github.com/${{ github.repository }}/releases"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" -d "chat_id=${TELEGRAM_CHAT_ID}" -d "text=${MESSAGE}"
            echo "Notification sent: +$DIFF downloads"
          else
            echo "No new downloads detected (current=$CURRENT, previous=$PREVIOUS)"
          fi

      - name: Save current counts
        run: |
          echo "${{ steps.current.outputs.total }}" > download-counts.txt
          cat download-counts.txt

      - name: Delete old cache
        continue-on-error: true
        run: |
          gh cache delete sajda-download-counts --repo ${{ github.repository }} || true

      - name: Save new cache
        uses: actions/cache/save@v4
        with:
          path: download-counts.txt
          key: sajda-download-counts
