name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'x64'
            target: 'x86_64-apple-darwin'

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          shared-key: ${{ matrix.args }}

      - name: Install dependencies
        run: npm ci

      - name: Import Apple Certificate
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-keychain-settings -t 3600 -u build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Build and Release
        id: tauri
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: v__VERSION__
          releaseName: 'Sajda v__VERSION__'
          releaseBody: 'See release notes for details.'
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: false
          args: ${{ matrix.args }}

      - name: Sign and upload signature file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          echo "Downloading tar.gz from release..."
          gh release download "v${VERSION}" --pattern "Sajda_${{ matrix.arch }}.app.tar.gz" --dir . || {
            echo "Failed to download, waiting and retrying..."
            sleep 10
            gh release download "v${VERSION}" --pattern "Sajda_${{ matrix.arch }}.app.tar.gz" --dir .
          }

          ls -la Sajda_${{ matrix.arch }}.app.tar.gz

          echo "Signing the tar.gz file..."
          # Use tauri CLI to sign the file
          npx tauri signer sign --private-key "$TAURI_SIGNING_PRIVATE_KEY" --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "Sajda_${{ matrix.arch }}.app.tar.gz"

          echo "Signature content:"
          cat "Sajda_${{ matrix.arch }}.app.tar.gz.sig"

          echo "Uploading signature to release..."
          gh release upload "v${VERSION}" "Sajda_${{ matrix.arch }}.app.tar.gz.sig" --clobber
          echo "Uploaded signature for ${{ matrix.arch }}"

  publish-updater:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for assets and download signatures
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p ./signatures

          for i in {1..10}; do
            echo "Attempt $i: Downloading signature files..."
            gh release download "v${VERSION}" --pattern "*.sig" --dir ./signatures --clobber 2>/dev/null || true

            if [ -f "./signatures/Sajda_aarch64.app.tar.gz.sig" ] && [ -f "./signatures/Sajda_x64.app.tar.gz.sig" ]; then
              echo "Both signature files found!"
              break
            fi

            echo "Waiting for signature files..."
            sleep 10
          done

          ls -la ./signatures/

      - name: Generate and upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          AARCH64_SIG=""
          X64_SIG=""

          if [ -f "./signatures/Sajda_aarch64.app.tar.gz.sig" ]; then
            AARCH64_SIG=$(cat ./signatures/Sajda_aarch64.app.tar.gz.sig)
            echo "Found aarch64 signature"
          else
            echo "WARNING: aarch64 signature not found"
          fi

          if [ -f "./signatures/Sajda_x64.app.tar.gz.sig" ]; then
            X64_SIG=$(cat ./signatures/Sajda_x64.app.tar.gz.sig)
            echo "Found x64 signature"
          else
            echo "WARNING: x64 signature not found"
          fi

          # Use jq to generate valid JSON
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See release notes for details." \
            --arg pub_date "$PUB_DATE" \
            --arg aarch64_sig "$AARCH64_SIG" \
            --arg aarch64_url "https://github.com/${REPO}/releases/download/v${VERSION}/Sajda_aarch64.app.tar.gz" \
            --arg x64_sig "$X64_SIG" \
            --arg x64_url "https://github.com/${REPO}/releases/download/v${VERSION}/Sajda_x64.app.tar.gz" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "darwin-aarch64": {
                  signature: $aarch64_sig,
                  url: $aarch64_url
                },
                "darwin-x86_64": {
                  signature: $x64_sig,
                  url: $x64_url
                }
              }
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "v${VERSION}" latest.json --clobber
          echo "Uploaded latest.json to release"
