name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'aarch64'
            target: 'aarch64-apple-darwin'
            os_type: 'macos'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'x64'
            target: 'x86_64-apple-darwin'
            os_type: 'macos'
          # Windows build
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            arch: 'x64-win'
            target: 'x86_64-pc-windows-msvc'
            os_type: 'windows'

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install Rust stable (macOS)
        if: matrix.os_type == 'macos'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install Rust stable (Windows)
        if: matrix.os_type == 'windows'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'
          shared-key: ${{ matrix.target }}

      - name: Install dependencies
        run: npm ci

      - name: Import Apple Certificate
        if: matrix.os_type == 'macos'
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-keychain-settings -t 3600 -u build.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Build and Release (macOS)
        if: matrix.os_type == 'macos'
        id: tauri-macos
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          # Fix Swift runtime linking for older macOS versions (10.15+)
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        with:
          tagName: v__VERSION__
          releaseName: 'Sajda v__VERSION__'
          releaseBody: 'See release notes for details.'
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: false
          args: ${{ matrix.args }}

      - name: Build and Release (Windows)
        if: matrix.os_type == 'windows'
        id: tauri-windows
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'Sajda v__VERSION__'
          releaseBody: 'See release notes for details.'
          releaseDraft: true
          prerelease: false
          includeUpdaterJson: false
          args: ${{ matrix.args }}

      - name: Sign and upload signature file (macOS)
        if: matrix.os_type == 'macos'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          echo "Downloading tar.gz from release..."
          gh release download "v${VERSION}" --pattern "Sajda_${{ matrix.arch }}.app.tar.gz" --dir . || {
            echo "Failed to download, waiting and retrying..."
            sleep 10
            gh release download "v${VERSION}" --pattern "Sajda_${{ matrix.arch }}.app.tar.gz" --dir .
          }

          ls -la Sajda_${{ matrix.arch }}.app.tar.gz

          echo "Signing the tar.gz file..."
          npx tauri signer sign --private-key "$TAURI_SIGNING_PRIVATE_KEY" --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "Sajda_${{ matrix.arch }}.app.tar.gz"

          echo "Signature content:"
          cat "Sajda_${{ matrix.arch }}.app.tar.gz.sig"

          echo "Uploading signature to release..."
          gh release upload "v${VERSION}" "Sajda_${{ matrix.arch }}.app.tar.gz.sig" --clobber
          echo "Uploaded signature for ${{ matrix.arch }}"

      - name: Sign and upload signature file (Windows)
        if: matrix.os_type == 'windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}".TrimStart('v')

          Write-Host "Downloading NSIS zip from release..."
          $maxRetries = 3
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              gh release download "v$VERSION" --pattern "Sajda_${VERSION}_x64-setup.nsis.zip" --dir . 2>$null
              if (Test-Path "Sajda_${VERSION}_x64-setup.nsis.zip") {
                $success = $true
              }
            } catch {
              $retryCount++
              Write-Host "Retry $retryCount..."
              Start-Sleep -Seconds 10
            }
          }

          if (-not $success) {
            Write-Host "WARNING: Could not download NSIS zip, skipping signing"
            exit 0
          }

          Get-ChildItem "Sajda_${VERSION}_x64-setup.nsis.zip"

          Write-Host "Signing the NSIS zip file..."
          npx tauri signer sign --private-key "$env:TAURI_SIGNING_PRIVATE_KEY" --password "$env:TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "Sajda_${VERSION}_x64-setup.nsis.zip"

          Write-Host "Signature content:"
          Get-Content "Sajda_${VERSION}_x64-setup.nsis.zip.sig"

          Write-Host "Uploading signature to release..."
          gh release upload "v$VERSION" "Sajda_${VERSION}_x64-setup.nsis.zip.sig" --clobber
          Write-Host "Uploaded Windows signature"

  publish-updater:
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Wait for assets and download signatures
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p ./signatures

          # Wait for all signature files (macOS + Windows)
          for i in {1..15}; do
            echo "Attempt $i: Downloading signature files..."
            gh release download "v${VERSION}" --pattern "*.sig" --dir ./signatures --clobber 2>/dev/null || true

            MACOS_ARM=$(test -f "./signatures/Sajda_aarch64.app.tar.gz.sig" && echo "yes" || echo "no")
            MACOS_X64=$(test -f "./signatures/Sajda_x64.app.tar.gz.sig" && echo "yes" || echo "no")
            WIN_X64=$(test -f "./signatures/Sajda_${VERSION}_x64-setup.nsis.zip.sig" && echo "yes" || echo "no")

            echo "  macOS ARM: $MACOS_ARM, macOS x64: $MACOS_X64, Windows x64: $WIN_X64"

            if [ "$MACOS_ARM" = "yes" ] && [ "$MACOS_X64" = "yes" ] && [ "$WIN_X64" = "yes" ]; then
              echo "All signature files found!"
              break
            fi

            # After 10 attempts, proceed with what we have (Windows might not be ready)
            if [ $i -ge 10 ] && [ "$MACOS_ARM" = "yes" ] && [ "$MACOS_X64" = "yes" ]; then
              echo "macOS signatures found, proceeding (Windows may be missing)"
              break
            fi

            echo "Waiting for signature files..."
            sleep 10
          done

          ls -la ./signatures/

      - name: Generate and upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          AARCH64_SIG=""
          X64_SIG=""
          WIN_X64_SIG=""

          if [ -f "./signatures/Sajda_aarch64.app.tar.gz.sig" ]; then
            AARCH64_SIG=$(cat ./signatures/Sajda_aarch64.app.tar.gz.sig)
            echo "Found aarch64 signature"
          else
            echo "WARNING: aarch64 signature not found"
          fi

          if [ -f "./signatures/Sajda_x64.app.tar.gz.sig" ]; then
            X64_SIG=$(cat ./signatures/Sajda_x64.app.tar.gz.sig)
            echo "Found x64 signature"
          else
            echo "WARNING: x64 signature not found"
          fi

          if [ -f "./signatures/Sajda_${VERSION}_x64-setup.nsis.zip.sig" ]; then
            WIN_X64_SIG=$(cat ./signatures/Sajda_${VERSION}_x64-setup.nsis.zip.sig)
            echo "Found Windows x64 signature"
          else
            echo "WARNING: Windows x64 signature not found"
          fi

          # Generate latest.json with all platforms
          jq -n \
            --arg version "$VERSION" \
            --arg notes "See release notes for details." \
            --arg pub_date "$PUB_DATE" \
            --arg aarch64_sig "$AARCH64_SIG" \
            --arg aarch64_url "https://github.com/${REPO}/releases/download/v${VERSION}/Sajda_aarch64.app.tar.gz" \
            --arg x64_sig "$X64_SIG" \
            --arg x64_url "https://github.com/${REPO}/releases/download/v${VERSION}/Sajda_x64.app.tar.gz" \
            --arg win_x64_sig "$WIN_X64_SIG" \
            --arg win_x64_url "https://github.com/${REPO}/releases/download/v${VERSION}/Sajda_${VERSION}_x64-setup.nsis.zip" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "darwin-aarch64": {
                  signature: $aarch64_sig,
                  url: $aarch64_url
                },
                "darwin-x86_64": {
                  signature: $x64_sig,
                  url: $x64_url
                },
                "windows-x86_64": {
                  signature: $win_x64_sig,
                  url: $win_x64_url
                }
              }
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

          gh release upload "v${VERSION}" latest.json --clobber
          echo "Uploaded latest.json to release"
